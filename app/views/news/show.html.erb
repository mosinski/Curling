<h3><%= @news.tytul %></h3>

<div class="redactor_editor">
  <%= @news.tekst_pl.html_safe %>
</div>

<hr>

<% @all_comments.each do |comment| %>
 <% @user = User.find(comment.user_id) %>

 <% if @user.potwierdzenie == 0 %>
 	<% @user.username = comment.body.lines.first %>
 <% end %>

<div class="comment">

 <div class="comment_avatar">
 	<%= image_tag(@user.avatar, :width => "50", "style" => "margin:5px;") %>
 </div>

 <div class="comment_user">
	<u><%= link_to @user.username, @user, "style"=>"font-weight:bold;" %> <%=I18n.l comment.created_at, :format => :long %></u> |
	<button id=<%= comment.id %> class="comment_reply btn btn-mini" title="<%= @user.username %>"><i class="icon-reply"></i></button>

	<% if current_user && current_user.role == "admin" %>
	<%= link_to({:controller => "news", :action => "destroy_comment", :id => comment.id}, {:confirm => "Czy napewno chcesz usunąć komentarz użytkownika #{@user.username}? \nZostaną również usunięte wszystkie odpowiedzi na ten komentarz."}) do %>
  		<i class="icon-trash" style="float:right;"></i>
	<% end %>
        <% end %>

	<br />
	<% if @user.potwierdzenie == 0 %>
		<%= Obscenity.sanitize(comment.body.sub(@user.username, '')) %>
	<% else %>
 		<%= Obscenity.sanitize(comment.body) %>
	<% end %>
 </div>
</div>
 <% if comment.has_children? %>
 	<% comment.children.each do |children| %>
    	  <% @user_children = User.find(children.user_id) %>
 	  <% if @user_children.potwierdzenie == 0 %>
 		<% @user_children.username = children.body.lines.first %>
 	  <% end %>
    		<div class="comment">
 			<div class="comment_reply_user">
				<% if @user_children.potwierdzenie == 0 %>
					<%= Obscenity.sanitize(children.body.sub(@user_children.username, '')) %> -
				<% else %>
					<%= Obscenity.sanitize(children.body) %> -
		 	  	<% end %> 
				<%= link_to @user_children.username, @user_children, "style"=>"font-weight:bold;" %> <%=I18n.l comment.created_at, :format => :short %>
				<% if current_user && current_user.role == "admin" %>
				<%= link_to({:controller => "news", :action => "destroy_comment", :id => children.id}, {:confirm => "Czy napewno chcesz usunąć komentarz użytkownika #{@user_children.username}?"}) do %>
  		<i class="icon-remove-circle" style="float:right;"></i>
				<% end %>
				<% end %>
 			</div>
    		</div>
  	<% end %>
  <% end %>

<% end %>

<hr>
<p id="comment_reply_username"></p>
<div class="comment">
<%= form_tag({controller: "news", action: "add_comment"}) do %>
  <%= hidden_field_tag "id", @news.id %>
  <%= hidden_field_tag "parrent_id" %>

  <% if current_user %>
  <%= image_tag(current_user.avatar, :class => "img-rounded", :width => "70", "style" => "margin:5px;") %>
  <% else %>
  <div>
  <%= label_tag "Nick", nil, "style" => "display:inline-block;width:80px;text-align:right;font-size:17px;" %>
  <%= text_field_tag "guest_name",nil, "style" => "display:inline-block;" %>
  </div>
  <%= image_tag("/avatar.jpg", :class => "img-rounded", :width => "70", "style" => "margin:5px;") %>
  <% end %>
  <%= text_area_tag :komentarz, nil, :rows => 3, "style" => "width:60%;" %>
  <button type="submit" class="btn btn-large btn-success">
  	<i class="icon-comment"></i>
     </button>
<% end %>
</div>

<%= link_to "/news",:class => "btn btn-small btn-primary" do %>
	<i class="icon-share-alt"></i> Wróć do listy
<% end %>

<script>
 $(".comment_reply").click(function () {
  var text = this.id
  var parent = this.title

  $("#parrent_id").val(text);
  $("p#comment_reply_username").text('Odpowiadasz na komentarz: ' + parent);
});
</script>
